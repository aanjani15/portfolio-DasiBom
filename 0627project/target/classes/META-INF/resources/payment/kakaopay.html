<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ</title>
<script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
<link rel="stylesheet" href="/dasibom/CSS/kakaopay.css">

</head>
<body>
	<h1>ì¹´ì¹´ì˜¤í˜ì´ë¡œ ê²°ì œ</h1>
	<button id="kyulje">í…ŒìŠ¤íŠ¸ ê²°ì œí•˜ê¸°</button>

	<script>
    document.getElementById('kyulje').addEventListener('click', () => {
      const IMP = window.IMP;
      IMP.init('imp22446627'); // ê°€ë§¹ì  ì½”ë“œ

      const storedData = localStorage.getItem("orderData");
      if (!storedData) {
        alert("ì£¼ë¬¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const orderData = JSON.parse(storedData);

      // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
      console.log("ğŸ”¥ orderData:", orderData);
      
      const sumPrice = parseInt(orderData.sumPrice || "0");
      const usedPoint = parseInt(orderData.usedPoint || "0");
      const amount = parseInt(orderData.sumPrice || "0"); // âœ… ìˆ˜ì •
      orderData.finalPrice = amount;
      localStorage.setItem("orderData", JSON.stringify(orderData));

      console.log("ğŸ”¥ sumPrice í™•ì¸:", orderData.sumPrice, typeof orderData.sumPrice);

      console.log("ğŸ”¥ amount ìµœì¢…ê°’:", amount, typeof amount);

      if (amount <= 0) {
        alert("ê²°ì œ ê¸ˆì•¡ì´ 0ì›ì´ê±°ë‚˜ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
        console.error("âŒ ì˜ëª»ëœ ê¸ˆì•¡:", amount, orderData);
        return;
      }

      // ìƒí’ˆëª… êµ¬ì„±
      let productName = "ë„ì„œì£¼ë¬¸";
      if (orderData.orderList && orderData.orderList.length > 0) {
        const firstTitle = orderData.orderList[0].title;
        const totalCount = orderData.orderList.length;
        if (firstTitle && firstTitle.trim().length > 0) {
          productName = totalCount > 1
            ? `${firstTitle} ì™¸ ${totalCount - 1}ê¶Œ`
            : firstTitle;
        }
      }

      const requestData = {
        pg: 'kakaopay',
        pay_method: 'card',
        merchant_uid: `order_${new Date().getTime()}`,
        name: productName,
        amount: amount,
        buyer_name: orderData.receiver,
        buyer_addr: orderData.address
      };

      console.log("ğŸ“¦ requestData to IMP:", requestData);

      IMP.request_pay(requestData, (response) => {
        if (response.success) {
          alert(`ê²°ì œ ì™„ë£Œ! ê²°ì œê¸ˆì•¡: ${response.paid_amount}ì›`);
          console.log('âœ… ê²°ì œ ì„±ê³µ:', response);

          fetch("/dasibom/orderInsert.do", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(orderData)
          })
          .then(res => {
            if (!res.ok) {
              throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: " + res.status);
            }
            return res.json();
          })
          .then(data => {
            console.log("ì„œë²„ ì‘ë‹µ:", data);
            if (data.result === "success") {
            	const orderId = data.orderId;
            	const finalUrl = `/dasibom/paymentComplete.do?orderId=${orderId}`;
            	console.log("â¡ ìµœì¢… ì´ë™ ì£¼ì†Œ:", finalUrl);  // ğŸ‘ˆ ì´ê±° ì¶”ê°€
            	window.location.href = finalUrl;
            } else {
              alert("ì„œë²„ ì˜¤ë¥˜: " + JSON.stringify(data));
            }
          })
          .catch(err => {
            console.error("âŒ JSON ì²˜ë¦¬ ì˜¤ë¥˜:", err);
            alert("ì„œë²„ê°€ JSONì„ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n" + err);
          });

        } else {
          alert(`ê²°ì œ ì‹¤íŒ¨: ${response.error_msg}`);
          console.error('âŒ ê²°ì œ ì‹¤íŒ¨:', response);
        }
      });
    });
  </script>
</body>
</html>
